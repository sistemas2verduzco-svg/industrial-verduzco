<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat치logo (Consulta)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#1976d2">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">游닍 Cat치logo</h1>
            <!-- minimal nav for public view -->
            <ul class="nav-links">
                <li><a href="/" class="btn-nav">Inicio</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="filtros-section">
            <h3>Consulta de Productos</h3>
            <div class="filtros-grid">
                <div class="form-group" style="position: relative;">
                    <label for="consulta-buscar">Buscar producto</label>
                    <input id="consulta-buscar" type="search" placeholder="Producto..." class="filtro-input" autocomplete="off" aria-autocomplete="list" aria-controls="consulta-sugerencias" style="padding-right: 2.8rem;">
                    <button type="button" id="consulta-clear" aria-label="Limpiar b칰squeda" style="position: absolute; right: 0.4rem; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.6rem; color: #555; cursor: pointer; display: none; width: 1.8rem; height: 1.8rem; z-index: 10; padding: 0; line-height: 1; font-weight: bold;">&times;</button>

                    <ul id="consulta-sugerencias" role="listbox" aria-label="Sugerencias" style="position: absolute; left: 0; right: 0; top: calc(100% + 0.4rem); background: #fff; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.08); list-style: none; margin: 0; padding: 0; max-height: 12rem; overflow-y: auto; z-index: 3; display: none;">
                    </ul>

                    <style>
                        @media (max-width:600px){ #consulta-clear{ font-size:1.8rem !important; width:2rem !important; height:2rem !important; right:0.4rem !important; } }
                        /* Ocultar X nativa del input type=search */
                        #consulta-buscar::-webkit-search-cancel-button { display: none; }
                        #consulta-buscar::-moz-search-cancel-button { display: none; }
                        #consulta-sugerencias li{ padding:0.6rem 0.8rem; border-bottom:1px solid #f0f0f0; cursor:pointer }
                        #consulta-sugerencias li.selected{ background:#f5faff }
                        #consulta-sugerencias .small{ display:block; color:#666; font-size:0.85rem; margin-top:0.15rem }
                    </style>
                </div>
                <div class="form-group">
                    <label for="consulta-categoria">Categoria</label>
                    <select id="consulta-categoria" class="filtro-input">
                        <option value="">Todas las categorias</option>
                    </select>
                </div>
                <button id="consulta-buscar-btn" class="btn btn-primary">Buscar</button>
            </div>
        </div>

        <div id="consulta-productos" class="productos-grid">
            <div class="loading">Cargando productos...</div>
        </div>
    </div>

    <footer>
        <p style="text-align:center;color:#888;padding:1rem 0;">&copy; 2025 Cat치logo - Consulta</p>
    </footer>

    <script>
        async function fetchJson(url) {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Error en la petici칩n: ' + res.status);
            return res.json();
        }

        function renderProductos(productos) {
            const container = document.getElementById('consulta-productos');
            if (!productos || productos.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay productos disponibles</div>';
                return;
            }
            container.innerHTML = '';
            productos.forEach(p => {
                const card = document.createElement('div');
                card.className = 'producto-card';
                card.innerHTML = `
                    <div class="producto-imagen">${p.imagen_url ? `<img src="${p.imagen_url}" alt="${p.nombre}">` : '<div class="no-image">Sin imagen</div>'}</div>
                    <div class="producto-info">
                        <h3>${p.nombre}</h3>
                        <p class="categoria">${p.categoria || 'Sin categor칤a'}</p>
                        <p class="descripcion">${p.descripcion || ''}</p>
                        <div class="precio-stock"><span class="precio">$${(p.precio||0).toFixed(2)}</span></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function cargarCategorias() {
            try {
                const cats = await fetchJson('/public/categorias');
                const sel = document.getElementById('consulta-categoria');
                cats.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    sel.appendChild(opt);
                });
            } catch (e) {
                console.warn('No se pudieron cargar categor칤as (todav칤a).', e);
            }
        }

        async function cargarProductosConsulta(params) {
            try {
                let url = '/public/productos';
                if (params) url = '/public/productos/buscar?' + new URLSearchParams(params).toString();
                const productos = await fetchJson(url);
                renderProductos(productos);
            } catch (e) {
                console.error(e);
                document.getElementById('consulta-productos').innerHTML = '<div class="error">Error cargando productos</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', function(){
            cargarCategorias();
            cargarProductosConsulta();

            const input = document.getElementById('consulta-buscar');
            const btn = document.getElementById('consulta-buscar-btn');
            const clearBtn = document.getElementById('consulta-clear');
            const sugerencias = document.getElementById('consulta-sugerencias');

            btn.addEventListener('click', function(){
                const q = input.value.trim();
                const cat = document.getElementById('consulta-categoria').value;
                const params = {};
                if (q) params.q = q;
                if (cat) params.categoria = cat;
                cargarProductosConsulta(params);
            });

            // Debounce helper
            let debounceTimer = null;
            function debounce(fn, wait){ return function(...args){ clearTimeout(debounceTimer); debounceTimer = setTimeout(()=> fn.apply(this,args), wait); }; }

            async function fetchSugerenciasConsulta(q){
                try{
                    const params = new URLSearchParams();
                    if (q) params.append('q', q);
                    params.append('limit', 8);
                    const res = await fetch('/public/productos/buscar?' + params.toString());
                    return await res.json();
                }catch(e){ console.error('Error fetch sugerencias public:', e); return []; }
            }

            function renderSugerenciasConsulta(items){
                sugerencias.innerHTML = '';
                if (!items || items.length === 0){ sugerencias.style.display = 'none'; return; }
                items.slice(0,8).forEach((p,i)=>{
                    const li = document.createElement('li');
                    li.dataset.index = i;
                    li.innerHTML = `<strong>${escapeHtml(p.nombre)}</strong><span class="small">${escapeHtml(p.categoria||'')}</span>`;
                    li.addEventListener('click', function(){ input.value = p.nombre; sugerencias.style.display = 'none'; btn.click(); });
                    li.addEventListener('touchstart', function(e){ e.preventDefault(); input.value = p.nombre; sugerencias.style.display = 'none'; btn.click(); });
                    sugerencias.appendChild(li);
                });
                sugerencias.style.display = 'block';
            }

            function escapeHtml(text){ if (!text) return ''; return text.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]; }); }

            const handleInput = debounce(async function(){
                const q = input.value.trim();
                clearBtn.style.display = q ? 'block' : 'none';
                if (q){
                    const results = await fetchSugerenciasConsulta(q);
                    renderSugerenciasConsulta(results);
                } else {
                    renderSugerenciasConsulta([]);
                    // mostrar todos
                    cargarProductosConsulta();
                }
            }, 300);

            input.addEventListener('input', handleInput);

            // teclado para sugerencias
            let selected = -1;
            input.addEventListener('keydown', function(e){
                const items = sugerencias.querySelectorAll('li');
                if (!items.length) return;
                if (e.key === 'ArrowDown'){ e.preventDefault(); selected = Math.min(selected+1, items.length-1); items.forEach(n=>n.classList.remove('selected')); items[selected].classList.add('selected'); items[selected].scrollIntoView({block:'nearest'}); }
                else if (e.key === 'ArrowUp'){ e.preventDefault(); selected = Math.max(selected-1,0); items.forEach(n=>n.classList.remove('selected')); items[selected].classList.add('selected'); items[selected].scrollIntoView({block:'nearest'}); }
                else if (e.key === 'Enter'){ const sel = sugerencias.querySelector('li.selected'); if (sel){ e.preventDefault(); sel.click(); } }
                else if (e.key === 'Escape'){ sugerencias.style.display = 'none'; }
            });

            document.addEventListener('click', function(e){ if (!e.target.closest || (!e.target.closest('#consulta-sugerencias') && !e.target.closest('#consulta-buscar'))) sugerencias.style.display = 'none'; });

            function limpiarConsultaBuscador(){ input.value = ''; clearBtn.style.display = 'none'; renderSugerenciasConsulta([]); cargarProductosConsulta(); }
            clearBtn.addEventListener('click', limpiarConsultaBuscador);
            clearBtn.addEventListener('touchstart', function(e){ e.preventDefault(); limpiarConsultaBuscador(); });

            input.addEventListener('keypress', function(e){ if (e.key === 'Enter') btn.click(); });
        });
    </script>
</body>
</html>
