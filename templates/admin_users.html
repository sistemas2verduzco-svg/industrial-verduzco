<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Admin - Usuarios</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    {% include '_sidebar.html' %}

    <div class="container" style="padding:40px 24px;">
        <h1>Gesti√≥n de Usuarios</h1>
        <p>Panel exclusivo para el usuario administrador. Desde aqu√≠ puedes administrar usuarios, roles y acceso.</p>

        <div style="margin-top:20px;">
            <button id="btn-refresh" class="btn btn-secondary">üîÑ Refrescar</button>
            <button id="btn-delete-nonadmin" class="btn btn-danger" style="margin-left:10px;">üóëÔ∏è Borrar todos excepto admin</button>
            <button id="btn-manage-roles" class="btn btn-primary" style="margin-left:10px;">‚öôÔ∏è Gestionar Roles/Permisos</button>
            <span id="mensaje" style="margin-left:12px; color:#333;"></span>
        </div>

        <!-- Crear usuario -->
        <div style="margin-top:18px; padding:12px; background:#f8fafc; border:1px solid #e6eef8; border-radius:6px;">
            <h3 style="margin:0 0 8px 0; font-size:15px;">Crear nuevo usuario</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <input id="new-username" placeholder="username" style="padding:8px;" />
                <input id="new-correo" placeholder="correo" style="padding:8px;" />
                <input id="new-password" placeholder="password" type="password" style="padding:8px;" />
                <select id="new-role" style="padding:8px;"><option value="">-- Role (opcional) --</option></select>
                <label style="display:flex; align-items:center; gap:6px; font-size:13px;"><input id="new-es-admin" type="checkbox" /> Es Admin</label>
                <button id="btn-create-user" class="btn btn-success">‚ûï Crear</button>
            </div>
        </div>

        <table id="users-table" style="width:100%; margin-top:20px; border-collapse:collapse;">
            <thead>
                <tr style="background:#f4f6f8; text-align:left;">
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Correo</th>
                    <th>Role</th>
                    <th>Activo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="users-body">
                <tr><td colspan="6">Cargando...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Modal Roles / M√≥dulos -->
    <div id="roles-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:9999;">
        <div style="width:800px; max-width:95%; margin:60px auto; background:#fff; border-radius:6px; padding:18px; box-shadow:0 6px 24px rgba(0,0,0,0.2);">
            <h3>Gestionar Roles y M√≥dulos</h3>
            <div style="display:flex; gap:12px; margin-top:12px;">
                <div style="flex:1; min-width:200px;">
                    <label><strong>Roles</strong></label>
                    <select id="roles-select" style="width:100%; padding:8px; margin-top:6px;"></select>
                </div>
                <div style="flex:2;">
                    <label><strong>M√≥dulos Accesibles</strong></label>
                    <div id="modules-list" style="max-height:320px; overflow:auto; border:1px solid #eee; padding:8px; margin-top:6px;"></div>
                </div>
            </div>
            <div style="margin-top:14px; text-align:right;">
                <button id="roles-cancel" class="btn">Cancelar</button>
                <button id="roles-save" class="btn btn-primary" style="margin-left:8px;">Guardar</button>
            </div>
        </div>
    </div>

<script>
async function fetchJson(url, opts){
    const res = await fetch(url, opts);
    if(!res.ok){
        const txt = await res.text();
        throw new Error(txt || res.status);
    }
    return res.json();
}

async function loadUsers(){
    try{
        const data = await fetchJson('/api/users');
        const tbody = document.getElementById('users-body');
        tbody.innerHTML = '';
        data.users.forEach(u=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${u.id}</td>
                <td>${u.username}${u.es_admin? ' <strong>(admin)</strong>':''}</td>
                <td>${u.correo||''}</td>
                <td>${u.role || ''}</td>
                <td>${u.activo? 'S√≠':'No'}</td>
                <td>
                    <button class="btn btn-secondary" onclick="toggleActive(${u.id})">Toggle</button>
                    <button class="btn btn-primary" onclick="showRolePrompt(${u.id}, '${u.role||''}')">Role</button>
                    ${u.username!=='admin'? `<button class="btn btn-info" onclick="viewPassword(${u.id})">Ver contrase√±a</button>`: ''}
                    <button class="btn btn-warning" onclick="editUser(${u.id})">Editar</button>
                    ${u.username!=='admin'? `<button class="btn btn-danger" onclick="deleteUser(${u.id})">Borrar</button>`: ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }catch(e){
        document.getElementById('users-body').innerHTML = '<tr><td colspan="6">Error cargando usuarios</td></tr>';
        console.error(e);
    }
}

async function viewPassword(id){
    try{
        const res = await fetch(`/api/users/${id}`);
        if(!res.ok) throw new Error(await res.text());
        const data = await res.json();
        const pwd = data.user.password;
        if(!pwd) alert('No hay contrase√±a disponible o no se puede desencriptar.');
        else alert('Contrase√±a: ' + pwd);
    }catch(e){ alert('Error: '+e.message); }
}

async function editUser(id){
    try{
        const correo = prompt('Nuevo correo (vac√≠o = sin cambio)');
        if(correo===null) return;
        const role = prompt('Role (admin, support) o vac√≠o para ninguno');
        if(role===null) return;
        const esAdminInput = prompt('Es admin? (s/n) o vac√≠o para no cambiar');
        if(esAdminInput===null) return;
        const password = prompt('Nueva contrase√±a (vac√≠o = mantener existente)');

        const payload = {};
        if(correo) payload.correo = correo;
        if(role !== null) payload.role = role || '';
        if(esAdminInput && (esAdminInput.toLowerCase()==='s' || esAdminInput.toLowerCase()==='si')) payload.es_admin = true;
        else if(esAdminInput && (esAdminInput.toLowerCase()==='n' || esAdminInput.toLowerCase()==='no')) payload.es_admin = false;
        if(password) payload.password = password;

        const res = await fetch(`/api/users/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        if(!res.ok) throw new Error(await res.text());
        await loadUsers();
        alert('Usuario actualizado');
    }catch(e){ alert('Error: '+e.message); }
}

// Create user
document.getElementById('btn-create-user').addEventListener('click', async ()=>{
    try{
        const username = document.getElementById('new-username').value.trim();
        const correo = document.getElementById('new-correo').value.trim();
        const password = document.getElementById('new-password').value;
        const role = document.getElementById('new-role').value || null;
        const es_admin = document.getElementById('new-es-admin').checked;
        if(!username || !password){ alert('username y password son requeridos'); return; }
        const res = await fetch('/api/users', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username, correo, password, role, es_admin})});
        if(!res.ok) throw new Error(await res.text());
        document.getElementById('new-username').value=''; document.getElementById('new-correo').value=''; document.getElementById('new-password').value='';
        await loadUsers();
        alert('Usuario creado');
    }catch(e){ alert('Error: '+e.message); }
});

// populate roles into create select
async function loadRolesIntoCreate(){
    try{
        const r = await fetch('/api/roles');
        if(!r.ok) return;
        const data = await r.json();
        const select = document.getElementById('new-role');
        if(!select) return;
        select.innerHTML = '<option value="">-- Role (opcional) --</option>';
        (data.roles||[]).forEach(role=>{
            const opt = document.createElement('option'); opt.value = role.name; opt.textContent = role.name;
            select.appendChild(opt);
        });
    }catch(e){ console.error('No se pudieron cargar roles', e); }
}

loadRolesIntoCreate();

async function toggleActive(id){
    try{
        await fetchJson(`/api/users/${id}/toggle_active`, {method:'PUT'});
        await loadUsers();
    }catch(e){ alert('Error: '+e.message); }
}

async function showRolePrompt(id, current){
    const role = prompt('Ingrese role (admin, support) o vac√≠o para ninguno', current||'');
    if(role===null) return;
    try{
        await fetchJson(`/api/users/${id}/role`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({role: role||null})});
        await loadUsers();
    }catch(e){ alert('Error: '+e.message); }
}

async function deleteUser(id){
    if(!confirm('¬øConfirmas borrar este usuario?')) return;
    try{
        await fetchJson(`/api/users/${id}`, {method:'DELETE'});
        await loadUsers();
    }catch(e){ alert('Error: '+e.message); }
}

document.getElementById('btn-refresh').addEventListener('click', loadUsers);

// Delete non-admins action
document.getElementById('btn-delete-nonadmin').addEventListener('click', async ()=>{
    if(!confirm('Esto borrar√° todos los usuarios excepto "admin". Continuar?')) return;
    try{
        const res = await fetch('/delete_nonadmin_users', {method:'POST'});
        if(!res.ok) throw new Error(await res.text());
        const txt = await res.text();
        document.getElementById('mensaje').textContent = txt;
        await loadUsers();
    }catch(e){ alert('Error: '+e.message); }
});

// Roles / M√≥dulos modal wiring
const MODULES = [
    {id: 'catalog', label: 'CAT√ÅLOGO', icon: 'üìä'},
    {id: 'soporte', label: 'SOPORTE', icon: 'üîß'},
    {id: 'admin_catalog', label: 'ADMINISTRACI√ìN CAT√ÅLOGO', icon: '‚öôÔ∏è'},
    {id: 'configuracion', label: 'CONFIGURACI√ìN', icon: 'üîë'}
];

document.getElementById('btn-manage-roles').addEventListener('click', async ()=>{
    try{
        await openRolesModal();
    }catch(e){ alert('Error: '+e.message); }
});

let ALL_ROLES = [];

async function openRolesModal(){
    const modal = document.getElementById('roles-modal');
    modal.style.display = 'block';
    const rolesResp = await fetchJson('/api/roles');
    ALL_ROLES = rolesResp.roles || rolesResp;

    const select = document.getElementById('roles-select');
    select.innerHTML = '';
    ALL_ROLES.forEach(r=>{
        const opt = document.createElement('option'); opt.value = r.id; opt.textContent = r.name + (r.description? ' ‚Äî '+r.description:'');
        select.appendChild(opt);
    });

    const mlist = document.getElementById('modules-list');
    mlist.innerHTML = '';
    MODULES.forEach(m=>{
        const id = 'mod_'+m.id;
        const row = document.createElement('div');
        row.style.marginBottom='8px; padding: 8px; background: #f5f5f5; border-radius: 4px;';
        row.innerHTML = `<label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" id="${id}" data-mod-id="${m.id}" /> <span style="font-weight:600;">${m.icon} ${m.label}</span></label>`;
        mlist.appendChild(row);
    });

    select.addEventListener('change', ()=>{ renderRoleModules(parseInt(select.value,10)); });

    if(ALL_ROLES.length) select.value = ALL_ROLES[0].id;
    renderRoleModules(parseInt(select.value,10));

    document.getElementById('roles-cancel').onclick = ()=>{ closeRolesModal(); };
    document.getElementById('roles-save').onclick = async ()=>{
        try{
            const rid = parseInt(select.value,10);
            const checked = Array.from(document.querySelectorAll('#modules-list input[type=checkbox]:checked')).map(i=>i.dataset.modId);
            const rolesData = {
                modules: checked,
                description: ALL_ROLES.find(r=>r.id===rid)?.description || ''
            };
            const res = await fetch(`/api/roles/${rid}/modules`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(rolesData)});
            if(!res.ok) throw new Error(await res.text());
            alert('M√≥dulos guardados');
            const newRoles = await fetchJson('/api/roles');
            ALL_ROLES = newRoles.roles || newRoles;
            renderRoleModules(rid);
        }catch(e){ alert('Error guardando m√≥dulos: '+e.message); }
    };
}

function closeRolesModal(){
    const modal = document.getElementById('roles-modal');
    modal.style.display = 'none';
}

function renderRoleModules(roleId){
    const role = ALL_ROLES.find(r=>r.id===roleId) || {modules:[]};
    const mods = (role.modules||[]);
    MODULES.forEach(m=>{
        const cb = document.getElementById('mod_'+m.id);
        if(cb) cb.checked = mods.indexOf(m.id) !== -1;
    });
}

// Inicial
loadUsers();
</script>
</body>
</html>
