<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo de Productos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">üì¶ Mi Cat√°logo</h1>
            <ul class="nav-links">
                <li><a href="/" class="btn-nav">Cat√°logo</a></li>
                <li><a href="/admin" class="btn-nav">Administrar</a></li>
                <li><a href="/proveedores" class="btn-nav" title="Gestionar Proveedores">üè¢ Proveedores</a></li>
                <li><a href="/logout" class="btn-logout">Cerrar Sesi√≥n</a></li>
            </ul>
        </div>
    </nav>

    <!-- Secci√≥n de filtros y b√∫squeda -->
    <div class="container" style="margin-top: 2rem;">
        <div class="filtros-section" style="background: #f9f9f9; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
            <h3 style="margin-top: 0; color: #333;">üîç Buscar y Filtrar Productos</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto auto; gap: 1rem; align-items: end;">
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: #555;">Nombre o descripci√≥n</label>
                    <input type="text" id="buscar-producto" placeholder="üîç Buscar..." class="filtro-input" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: #555;">Categor√≠a</label>
                    <input type="text" id="filtro-categoria" placeholder="üè∑Ô∏è Categor√≠a..." class="filtro-input" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: #555;">Precio m√≠n.</label>
                    <input type="number" id="filtro-precio-min" placeholder="Min" step="0.01" class="filtro-input" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: #555;">Precio m√°x.</label>
                    <input type="number" id="filtro-precio-max" placeholder="M√°x" step="0.01" class="filtro-input" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <button class="btn btn-primary" onclick="aplicarFiltros()" style="padding: 0.6rem 1.2rem;">üîé Buscar</button>
                <button class="btn btn-secondary" onclick="limpiarFiltros()" style="padding: 0.6rem 1.2rem; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;">üîÑ Limpiar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h2>Cat√°logo de Productos</h2>
            <p id="estadisticas" class="stats"></p>
        </div>

        <div id="productos-container" class="productos-grid">
            <!-- Los productos se cargar√°n aqu√≠ con JavaScript -->
            <div class="loading">Cargando productos...</div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Cat√°logo Web. Todos los derechos reservados.</p>
    </footer>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        // Helper: parse JSON safely checking content-type
        async function parseJsonSafe(response) {
            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error('Respuesta no JSON: ' + text);
            }
            return response.json();
        }

        // Cargar productos y estad√≠sticas al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarProductos();
            cargarEstadisticas();

            // Activar el enlace del nav correspondiente seg√∫n la ruta
            (function(){
                const links = document.querySelectorAll('.nav-links a.btn-nav');
                const path = window.location.pathname || '/';
                links.forEach(a => {
                    try {
                        const href = a.getAttribute('href');
                        if (href === path) {
                            a.classList.add('active');
                        } else {
                            a.classList.remove('active');
                        }
                    } catch(e){}
                });
            })();
        });

        function cargarProductos() {
            fetch('/api/productos')
                .then(response => parseJsonSafe(response))
                .then(productos => {
                    const container = document.getElementById('productos-container');
                    
                    if (productos.length === 0) {
                        container.innerHTML = '<div class="empty-state">No hay productos disponibles</div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    productos.forEach(producto => {
                        const card = document.createElement('div');
                        card.className = 'producto-card';
                        card.innerHTML = `
                            <div class="producto-imagen">
                                ${producto.imagen_url ? `<img src="${producto.imagen_url}" alt="${producto.nombre}">` : '<div class="no-image">Sin imagen</div>'}
                            </div>
                            <div class="producto-info">
                                <h3>${producto.nombre}</h3>
                                <p class="categoria">${producto.categoria || 'Sin categor√≠a'}</p>
                                <p class="descripcion">${producto.descripcion || 'Sin descripci√≥n'}</p>
                                <div class="precio-stock">
                                    <span class="precio">$${producto.precio.toFixed(2)}</span>
                                    <span class="stock">Stock: ${producto.cantidad}</span>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error cargando productos:', error);
                    document.getElementById('productos-container').innerHTML = '<div class="error">Error al cargar productos</div>';
                });
        }

        function cargarEstadisticas() {
            fetch('/api/estadisticas')
                .then(response => parseJsonSafe(response))
                .then(data => {
                    document.getElementById('estadisticas').innerHTML = `
                        Total de productos: <strong>${data.total_productos}</strong> | 
                        Valor total: <strong>$${data.valor_total_inventario.toFixed(2)}</strong>
                    `;
                })
                .catch(err => console.error('Error cargando estad√≠sticas:', err));
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const buscar = document.getElementById('buscar-producto').value.trim();
            const categoria = document.getElementById('filtro-categoria').value.trim();
            const precioMin = document.getElementById('filtro-precio-min').value.trim();
            const precioMax = document.getElementById('filtro-precio-max').value.trim();

            const params = new URLSearchParams();
            if (buscar) params.append('q', buscar);
            if (categoria) params.append('categoria', categoria);
            if (precioMin) params.append('precio_min', precioMin);
            if (precioMax) params.append('precio_max', precioMax);

            const url = '/api/productos/buscar' + (params.toString() ? '?' + params.toString() : '');

            fetch(url)
                .then(response => parseJsonSafe(response))
                .then(productos => {
                    const container = document.getElementById('productos-container');
                    
                    if (productos.length === 0) {
                        container.innerHTML = '<div class="empty-state">No se encontraron productos con esos filtros</div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    productos.forEach(producto => {
                        const card = document.createElement('div');
                        card.className = 'producto-card';
                        card.innerHTML = `
                            <div class="producto-imagen">
                                ${producto.imagen_url ? `<img src="${producto.imagen_url}" alt="${producto.nombre}">` : '<div class="no-image">Sin imagen</div>'}
                            </div>
                            <div class="producto-info">
                                <h3>${producto.nombre}</h3>
                                <p class="categoria">${producto.categoria || 'Sin categor√≠a'}</p>
                                <p class="descripcion">${producto.descripcion || 'Sin descripci√≥n'}</p>
                                <div class="precio-stock">
                                    <span class="precio">$${producto.precio.toFixed(2)}</span>
                                    <span class="stock">Stock: ${producto.cantidad}</span>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error aplicando filtros:', error);
                    document.getElementById('productos-container').innerHTML = '<div class="error">Error al filtrar productos: ' + error.message + '</div>';
                });
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('buscar-producto').value = '';
            document.getElementById('filtro-categoria').value = '';
            document.getElementById('filtro-precio-min').value = '';
            document.getElementById('filtro-precio-max').value = '';
            cargarProductos();
        }

        // Permitir Enter en los inputs de b√∫squeda
        document.addEventListener('DOMContentLoaded', function() {
            const searchInputs = [
                document.getElementById('buscar-producto'),
                document.getElementById('filtro-categoria'),
                document.getElementById('filtro-precio-min'),
                document.getElementById('filtro-precio-max')
            ];
            
            searchInputs.forEach(input => {
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            aplicarFiltros();
                        }
                    });
                }
            });
        });

        // Easter egg removed: moved behavior to login page only when login fails
    </script>
</body>
</html>
