<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat치logo de Productos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- PWA / Apple Home Screen metadata -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/apple-touch-icon-180.png') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#1976d2">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">游닍 Mi Cat치logo</h1>
            <ul class="nav-links">
                <li><a href="/" class="btn-nav">Cat치logo</a></li>
                <li><a href="/admin" class="btn-nav">Administrar</a></li>
                <li><a href="/proveedores" class="btn-nav" title="Gestionar Proveedores">游끽 Proveedores</a></li>
                <li><a href="/logout" class="btn-logout">Cerrar Sesi칩n</a></li>
            </ul>
        </div>
    </nav>

    <!-- Secci칩n de filtros y b칰squeda -->
    <div class="container">
        <div class="filtros-section">
            <h3>Buscar y Filtrar Productos</h3>
            <div class="filtros-grid">
                <div class="form-group" style="position: relative;">
                    <label for="buscar-producto">Nombre o descripcion</label>
                    <input type="text" id="buscar-producto" placeholder="Buscar..." class="filtro-input" style="padding-right: 2.8rem;" autocomplete="off" aria-autocomplete="list" aria-controls="sugerencias-busqueda">
                    <button type="button" id="clear-buscar" aria-label="Limpiar b칰squeda" style="position: absolute; right: 0.4rem; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.6rem; color: #555; cursor: pointer; display: none; width: 1.8rem; height: 1.8rem; z-index: 10; padding: 0; line-height: 1; font-weight: bold;">&times;</button>

                    <!-- Contenedor de sugerencias predictivas -->
                    <ul id="sugerencias-busqueda" role="listbox" aria-label="Sugerencias" style="position: absolute; left: 0; right: 0; top: calc(100% + 0.4rem); background: #fff; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.08); list-style: none; margin: 0; padding: 0; max-height: 14rem; overflow-y: auto; z-index: 3; display: none;">
                        <!-- items din치micos -->
                    </ul>

                    <style>
                        @media (max-width: 600px) {
                            #clear-buscar { font-size: 1.8rem !important; width: 2rem !important; height: 2rem !important; right: 0.4rem !important; }
                        }
                        #sugerencias-busqueda li { padding: 0.6rem 0.8rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
                        #sugerencias-busqueda li:active, #sugerencias-busqueda li.selected { background: #f5faff; }
                        #sugerencias-busqueda .small { display: block; color: #666; font-size: 0.85rem; margin-top: 0.2rem; }
                    </style>
                </div>
                <div class="form-group">
                    <label for="filtro-categoria">Categoria</label>
                    <input type="text" id="filtro-categoria" placeholder="Categoria..." class="filtro-input">
                </div>
                <div class="form-group">
                    <label for="filtro-precio-min">Precio minimo</label>
                    <input type="number" id="filtro-precio-min" placeholder="Min" step="0.01" class="filtro-input">
                </div>
                <div class="form-group">
                    <label for="filtro-precio-max">Precio maximo</label>
                    <input type="number" id="filtro-precio-max" placeholder="Max" step="0.01" class="filtro-input">
                </div>
                <button class="btn btn-primary" onclick="aplicarFiltros()">Buscar</button>
                <button class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h2>Cat치logo de Productos</h2>
            <p id="estadisticas" class="stats"></p>
        </div>

        <div id="productos-container" class="productos-grid">
            <!-- Los productos se cargar치n aqu칤 con JavaScript -->
            <div class="loading">Cargando productos...</div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Cat치logo Web. Todos los derechos reservados.</p>
    </footer>

    <!-- Bottom navigation (mobile) -->
    <nav class="bottom-nav" role="navigation" aria-label="Barra inferior">
        <a href="/" class="bn-item" data-path="/">
            <span class="bn-icon">游</span>
            <span class="bn-label">Cat치logo</span>
        </a>
        <a href="/admin" class="bn-item" data-path="/admin">
            <span class="bn-icon">丘뙖잺</span>
            <span class="bn-label">Admin</span>
        </a>
        <a href="/proveedores" class="bn-item" data-path="/proveedores">
            <span class="bn-icon">游끽</span>
            <span class="bn-label">Proveedores</span>
        </a>
        <a href="/logout" class="bn-item" data-path="/logout">
            <span class="bn-icon">游</span>
            <span class="bn-label">Salir</span>
        </a>
    </nav>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        // Helper: parse JSON safely checking content-type
        async function parseJsonSafe(response) {
            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error('Respuesta no JSON: ' + text);
            }
            return response.json();
        }

        // Cargar productos y estad칤sticas al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarProductos();
            cargarEstadisticas();

            // Activar el enlace del nav correspondiente seg칰n la ruta
            (function(){
                const links = document.querySelectorAll('.nav-links a.btn-nav');
                const path = window.location.pathname || '/';
                links.forEach(a => {
                    try {
                        const href = a.getAttribute('href');
                        if (href === path) {
                            a.classList.add('active');
                        } else {
                            a.classList.remove('active');
                        }
                    } catch(e){}
                });
            })();

            // Mostrar/ocultar bot칩n X en el input de b칰squeda
            const buscarInput = document.getElementById('buscar-producto');
            const clearBtn = document.getElementById('clear-buscar');
            if (buscarInput && clearBtn) {
                    // Elementos relacionados con sugerencias
                    const sugerenciasList = document.getElementById('sugerencias-busqueda');
                    let debounceTimer = null;
                    let selectedIndex = -1;

                    function debounce(fn, wait) {
                        return function(...args) {
                            clearTimeout(debounceTimer);
                            debounceTimer = setTimeout(() => fn.apply(this, args), wait);
                        };
                    }

                    async function fetchSugerencias(q) {
                        try {
                            const params = new URLSearchParams();
                            if (q) params.append('q', q);
                            params.append('limit', 8);
                            const res = await fetch('/api/productos/buscar?' + params.toString());
                            const lista = await parseJsonSafe(res);
                            return lista;
                        } catch (err) {
                            console.error('Error sugiriendo:', err);
                            return [];
                        }
                    }

                    function renderSugerencias(items) {
                        sugerenciasList.innerHTML = '';
                        if (!items || items.length === 0) {
                            sugerenciasList.style.display = 'none';
                            selectedIndex = -1;
                            return;
                        }
                        items.slice(0, 8).forEach((p, i) => {
                            const li = document.createElement('li');
                            li.setAttribute('role', 'option');
                            li.dataset.index = i;
                            li.innerHTML = `<strong>${escapeHtml(p.nombre)}</strong><span class="small">${escapeHtml(p.categoria || '')}</span>`;
                            li.addEventListener('click', function() {
                                buscarInput.value = p.nombre;
                                sugerenciasList.style.display = 'none';
                                aplicarFiltros();
                            });
                            li.addEventListener('touchstart', function(e) { e.preventDefault(); buscarInput.value = p.nombre; sugerenciasList.style.display = 'none'; aplicarFiltros(); });
                            sugerenciasList.appendChild(li);
                        });
                        sugerenciasList.style.display = 'block';
                        selectedIndex = -1;
                    }

                    function escapeHtml(text) {
                        if (!text) return '';
                        return text.replace(/[&<>"']/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]; });
                    }

                    const handleInput = debounce(async function() {
                        const q = buscarInput.value.trim();
                        clearBtn.style.display = q ? 'block' : 'none';
                        if (q) {
                            const results = await fetchSugerencias(q);
                            renderSugerencias(results);
                        } else {
                            renderSugerencias([]);
                            // si est치 vac칤o, mostrar todos
                            limpiarFiltros();
                        }
                    }, 300);

                    buscarInput.addEventListener('input', handleInput);

                    // Teclado: navegar por las sugerencias
                    buscarInput.addEventListener('keydown', function(e) {
                        const items = sugerenciasList.querySelectorAll('li');
                        if (!items.length) return;
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                            items.forEach(n => n.classList.remove('selected'));
                            items[selectedIndex].classList.add('selected');
                            items[selectedIndex].scrollIntoView({block: 'nearest'});
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            selectedIndex = Math.max(selectedIndex - 1, 0);
                            items.forEach(n => n.classList.remove('selected'));
                            items[selectedIndex].classList.add('selected');
                            items[selectedIndex].scrollIntoView({block: 'nearest'});
                        } else if (e.key === 'Enter') {
                            const sel = sugerenciasList.querySelector('li.selected');
                            if (sel) {
                                e.preventDefault();
                                sel.click();
                            }
                        } else if (e.key === 'Escape') {
                            sugerenciasList.style.display = 'none';
                        }
                    });

                    // ocultar sugerencias al clicar fuera
                    document.addEventListener('click', function(e) {
                        if (!e.target.closest || !e.target.closest('#sugerencias-busqueda') && !e.target.closest('#buscar-producto')) {
                            if (sugerenciasList) sugerenciasList.style.display = 'none';
                        }
                    });

                    // clear button behavior
                    clearBtn.addEventListener('touchstart', function(e) { e.preventDefault(); buscarInput.value = ''; clearBtn.style.display = 'none'; renderSugerencias([]); limpiarFiltros(); });
                    clearBtn.addEventListener('click', function(e) { e.preventDefault(); buscarInput.value = ''; clearBtn.style.display = 'none'; renderSugerencias([]); limpiarFiltros(); });
            }
        });

        function cargarProductos() {
            fetch('/api/productos')
                .then(response => parseJsonSafe(response))
                .then(productos => {
                    const container = document.getElementById('productos-container');
                    if (productos.length === 0) {
                        container.innerHTML = '<div class="empty-state">No hay productos disponibles</div>';
                        return;
                    }
                    container.innerHTML = '';
                    productos.forEach(producto => {
                        const card = document.createElement('div');
                        card.className = 'producto-card producto-clickeable';
                        card.style.cursor = 'pointer';
                        card.onclick = function() {
                            window.location.href = `/producto/${producto.id}`;
                        };
                        card.innerHTML = `
                            <div class="producto-imagen">
                                ${producto.imagen_url ? `<img src="${producto.imagen_url}" alt="${producto.nombre}">` : '<div class="no-image">Sin imagen</div>'}
                            </div>
                            <div class="producto-info">
                                <h3>${producto.nombre}</h3>
                                <p class="categoria">${producto.categoria || 'Sin categor칤a'}</p>
                                <p class="descripcion">${producto.descripcion || 'Sin descripci칩n'}</p>
                                <div class="precio-stock">
                                    <span class="precio">$${producto.precio.toFixed(2)}</span>
                                    <span class="stock">Stock: ${producto.cantidad}</span>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error cargando productos:', error);
                    document.getElementById('productos-container').innerHTML = '<div class="error">Error al cargar productos</div>';
                });
                // Efecto visual para tarjetas clickeables
                const style = document.createElement('style');
                style.innerHTML = `
                    .producto-clickeable:hover {
                        box-shadow: 0 0 0 3px #1976d2, 0 2px 8px rgba(0,0,0,0.10);
                        transform: translateY(-2px) scale(1.02);
                        transition: box-shadow 0.2s, transform 0.2s;
                    }
                `;
                document.head.appendChild(style);
        }

        function cargarEstadisticas() {
            fetch('/api/estadisticas')
                .then(response => parseJsonSafe(response))
                .then(data => {
                    document.getElementById('estadisticas').innerHTML = `
                        Total de productos: <strong>${data.total_productos}</strong> | 
                        Valor total: <strong>$${data.valor_total_inventario.toFixed(2)}</strong>
                    `;
                })
                .catch(err => console.error('Error cargando estad칤sticas:', err));
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const buscar = document.getElementById('buscar-producto').value.trim();
            const categoria = document.getElementById('filtro-categoria').value.trim();
            const precioMin = document.getElementById('filtro-precio-min').value.trim();
            const precioMax = document.getElementById('filtro-precio-max').value.trim();

            const params = new URLSearchParams();
            if (buscar) params.append('q', buscar);
            if (categoria) params.append('categoria', categoria);
            if (precioMin) params.append('precio_min', precioMin);
            if (precioMax) params.append('precio_max', precioMax);

            const url = '/api/productos/buscar' + (params.toString() ? '?' + params.toString() : '');

            fetch(url)
                .then(response => parseJsonSafe(response))
                .then(productos => {
                    const container = document.getElementById('productos-container');
                    if (productos.length === 0) {
                        container.innerHTML = '<div class="empty-state">No se encontraron productos con esos filtros</div>';
                        return;
                    }
                    container.innerHTML = '';
                    productos.forEach(producto => {
                        const card = document.createElement('div');
                        card.className = 'producto-card producto-clickeable';
                        card.style.cursor = 'pointer';
                        card.onclick = function() {
                            window.location.href = `/producto/${producto.id}`;
                        };
                        card.innerHTML = `
                            <div class="producto-imagen">
                                ${producto.imagen_url ? `<img src="${producto.imagen_url}" alt="${producto.nombre}">` : '<div class="no-image">Sin imagen</div>'}
                            </div>
                            <div class="producto-info">
                                <h3>${producto.nombre}</h3>
                                <p class="categoria">${producto.categoria || 'Sin categor칤a'}</p>
                                <p class="descripcion">${producto.descripcion || 'Sin descripci칩n'}</p>
                                <div class="precio-stock">
                                    <span class="precio">$${producto.precio.toFixed(2)}</span>
                                    <span class="stock">Stock: ${producto.cantidad}</span>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error aplicando filtros:', error);
                    document.getElementById('productos-container').innerHTML = '<div class="error">Error al filtrar productos: ' + error.message + '</div>';
                });
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('buscar-producto').value = '';
            document.getElementById('filtro-categoria').value = '';
            document.getElementById('filtro-precio-min').value = '';
            document.getElementById('filtro-precio-max').value = '';
            cargarProductos();
        }

        // Permitir Enter en los inputs de b칰squeda
        document.addEventListener('DOMContentLoaded', function() {
            const searchInputs = [
                document.getElementById('buscar-producto'),
                document.getElementById('filtro-categoria'),
                document.getElementById('filtro-precio-min'),
                document.getElementById('filtro-precio-max')
            ];
            
            searchInputs.forEach(input => {
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            aplicarFiltros();
                        }
                    });
                }
            });
        });

        // Asegurar que la X quede perfectamente centrada respecto al input (correcci칩n por navegador y estilos)
        function alignClearButton(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(buttonId);
            if (!input || !btn) return;
            // bot칩n est치 posicionado absolutamente dentro de .form-group
            const parent = input.closest('.form-group');
            if (!parent) return;
            // calcular top relativo al parent
            const inputOffsetTop = input.offsetTop;
            const inputMid = inputOffsetTop + Math.round(input.offsetHeight / 2);
            btn.style.top = inputMid + 'px';
            btn.style.transform = 'translateY(-50%)';
        }

        function alignAllClearButtons() {
            alignClearButton('buscar-producto', 'clear-buscar');
            alignClearButton('consulta-buscar', 'consulta-clear');
        }

        window.addEventListener('resize', function() {
            // debounce ligero
            clearTimeout(window._alignClearTimer);
            window._alignClearTimer = setTimeout(alignAllClearButtons, 80);
        });
        // run once when script loads (after DOM ready handlers)
        document.addEventListener('DOMContentLoaded', alignAllClearButtons);

        // Easter egg removed: moved behavior to login page only when login fails
    </script>
</body>
</html>
