{% include '_sidebar.html' %}
<div class="admin-container" style="padding:24px; max-width:100%; margin-left:280px; box-sizing:border-box;">
  <h2 style="margin-bottom:20px; font-size:28px; font-weight:600; color:#1a202c;">Procesos y Claves de Producci√≥n</h2>
  {% if error %}
  <div style="padding:12px 16px; background:#fee; color:#c53030; border-radius:8px; margin-bottom:16px; border-left:4px solid #c53030;">{{ error }}</div>
  {% endif %}

  <div class="procesos-layout" style="display:grid; grid-template-columns: 280px minmax(auto, 900px); gap:20px; align-items:start; max-width:1300px;">
    <!-- Columna izquierda: Claves y Cat√°logo de procesos -->
    <div style="display:flex; flex-direction:column; gap:20px;">
      <!-- Claves -->
      <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <strong style="font-size:16px; color:#2d3748;">Claves de Producto</strong>
          <button id="btnNuevaClave" class="btn btn-sm" style="padding:8px 12px; border:none; background:#3182ce; color:#fff; border-radius:6px; cursor:pointer; font-size:13px; font-weight:500; transition:background 0.2s;">Nueva</button>
        </div>
        <input type="text" id="buscarClave" placeholder="üîç Buscar clave..." style="width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:12px; font-size:14px;">
        <div style="max-height:420px; overflow-y:auto; border-top:1px solid #edf2f7;">
          {% for c in claves %}
          <a href="{{ url_for('procesos_panel', clave_id=c.id) }}" style="display:block; padding:12px 8px; text-decoration:none; color:#2d3748; border-bottom:1px solid #f7fafc; transition:background 0.2s;" class="clave-item">
            <div style="font-weight:600; font-size:14px; color:#2b6cb0;">{{ c.clave }}</div>
            <div style="font-size:12px; color:#718096; margin-top:2px;">{{ c.nombre or 'Sin nombre' }}</div>
          </a>
          {% else %}
          <div style="color:#a0aec0; padding:16px; text-align:center; font-size:13px;">Sin claves registradas</div>
          {% endfor %}
        </div>
      </div>

      <!-- Cat√°logo de procesos -->
      <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 12px; font-size:16px; color:#2d3748; font-weight:600;">Cat√°logo de Procesos</h3>
        <form id="formProceso" action="{{ url_for('procesos_base_save') }}" method="POST" style="display:grid; gap:10px; margin-bottom:12px;">
          <input type="hidden" name="id" id="proc_id">
          <div>
            <label style="display:block; font-size:13px; font-weight:500; color:#4a5568; margin-bottom:4px;">Centro de trabajo</label>
            <input type="text" name="centro_trabajo" id="proc_ct" style="width:100%; padding:8px 10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
          </div>
          <div>
            <label style="display:block; font-size:13px; font-weight:500; color:#4a5568; margin-bottom:4px;">Operaci√≥n</label>
            <textarea name="operacion" id="proc_oper" rows="2" style="width:100%; padding:8px 10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px; resize:vertical;"></textarea>
          </div>
          <div>
            <label style="display:block; font-size:13px; font-weight:500; color:#4a5568; margin-bottom:4px;">T/E (HH:MM:SS)</label>
            <input type="text" name="tiempo_estimado" id="proc_te" placeholder="00:05:10" style="width:100%; padding:8px 10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
          </div>
          <div>
            <label style="display:block; font-size:13px; font-weight:500; color:#4a5568; margin-bottom:4px;">Nombre</label>
            <input type="text" name="nombre" id="proc_nombre" placeholder="Opcional" style="width:100%; padding:8px 10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
          </div>
          <div>
            <label style="display:block; font-size:13px; font-weight:500; color:#4a5568; margin-bottom:4px;">Descripci√≥n</label>
            <textarea name="descripcion" id="proc_desc" rows="2" style="width:100%; padding:8px 10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px; resize:vertical;"></textarea>
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="proc_activo" name="activo" checked style="width:16px; height:16px;">
            <label for="proc_activo" style="font-size:13px; color:#4a5568;">Activo</label>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button type="button" id="btnLimpiarProc" class="btn" style="padding:8px 12px; border:1px solid #e2e8f0; background:#f7fafc; border-radius:6px; cursor:pointer; font-size:13px; font-weight:500;">Limpiar</button>
            <button type="submit" class="btn" style="padding:8px 12px; border:none; background:#3182ce; color:#fff; border-radius:6px; cursor:pointer; font-size:13px; font-weight:500; transition:background 0.2s;">Guardar</button>
          </div>
        </form>

        <hr style="border:none; border-top:1px solid #edf2f7; margin:12px 0;">

        <input type="text" id="buscarProceso" placeholder="üîç Buscar proceso..." style="width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:12px; font-size:14px;">
        <div style="max-height:360px; overflow-y:auto; border-top:1px solid #edf2f7;">
          {% for p in procesos %}
          <div class="itemProc" data-id="{{ p.id }}" data-codigo="{{ p.codigo or '' }}" data-nombre="{{ p.nombre }}" data-oper="{{ p.operacion or '' }}" data-ct="{{ p.centro_trabajo or '' }}" data-te="{{ p.tiempo_estimado or '' }}" data-desc="{{ p.descripcion or '' }}" style="padding:10px 8px; border-bottom:1px solid #f7fafc;">
            <div style="font-size:13px; font-weight:600; color:#2d3748; margin-bottom:4px;">{{ p.centro_trabajo or 'C.T.?' }} - {{ p.operacion or p.nombre }}</div>
            <div style="font-size:12px; color:#718096; margin-bottom:8px;">{{ p.descripcion or '' }}</div>
            <div style="display:flex; gap:6px;">
              <button type="button" class="btnEditProc" style="padding:6px 10px; font-size:12px; border:1px solid #e2e8f0; background:#fff; border-radius:4px; cursor:pointer;">Editar</button>
              <form action="{{ url_for('procesos_base_delete', proc_id=p.id) }}" method="POST" onsubmit="return confirm('¬øEliminar proceso?');" style="display:inline;">
                <button type="submit" style="padding:6px 10px; font-size:12px; border:1px solid #fc8181; background:#fff; color:#c53030; border-radius:4px; cursor:pointer;">Eliminar</button>
              </form>
            </div>
          </div>
          {% else %}
          <div style="color:#a0aec0; padding:16px; text-align:center; font-size:13px;">Sin procesos en cat√°logo</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Columna derecha: Editor de clave y secuencia -->
    <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
      <h3 style="margin:0 0 16px; font-size:20px; color:#2d3748; font-weight:600;">{{ 'Editar Clave: ' ~ clave_sel.clave if clave_sel else 'Nueva Clave' }}</h3>
      <form action="{{ url_for('procesos_clave_save') }}" method="POST" style="margin-bottom:16px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:end;">
        {% if clave_sel %}
        <input type="hidden" name="id" value="{{ clave_sel.id }}">
        {% endif %}
        <div>
          <label style="display:block; font-size:13px; font-weight:500; color:#4a5568; margin-bottom:4px;">Clave *</label>
          <input type="text" name="clave" required value="{{ clave_sel.clave if clave_sel else '' }}" style="width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:8px; font-size:14px;">
        </div>
        <div>
          <label style="display:block; font-size:13px; font-weight:500; color:#4a5568; margin-bottom:4px;">Nombre del producto</label>
          <input type="text" name="nombre" value="{{ clave_sel.nombre if clave_sel else '' }}" style="width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:8px; font-size:14px;">
        </div>
        <div style="grid-column:1 / span 2;">
          <label style="display:block; font-size:13px; font-weight:500; color:#4a5568; margin-bottom:4px;">Notas</label>
          <textarea name="notas" rows="2" style="width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:8px; font-size:14px; resize:vertical;">{{ clave_sel.notas if clave_sel else '' }}</textarea>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="activo_clave" name="activo" {% if not clave_sel or clave_sel.activo %}checked{% endif %} style="width:16px; height:16px;">
          <label for="activo_clave" style="font-size:13px; color:#4a5568;">Activo</label>
        </div>
        <div style="text-align:right;">
          <button type="submit" class="btn" style="padding:10px 16px; border:none; background:#3182ce; color:#fff; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; transition:background 0.2s;">Guardar clave</button>
        </div>
      </form>

      <hr style="border:none; border-top:2px solid #edf2f7; margin:16px 0;">

      <h4 style="margin:0 0 12px; font-size:18px; color:#2d3748; font-weight:600;">Secuencia de Procesos</h4>
      {% if not clave_sel %}
      <div style="padding:20px; background:#f7fafc; border:2px dashed #cbd5e0; border-radius:8px; color:#718096; text-align:center;">Selecciona o crea una clave para configurar su secuencia de procesos.</div>
      {% else %}
      <form action="{{ url_for('procesos_clave_secuencia_save', clave_id=clave_sel.id) }}" method="POST" id="formSecuencia">
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:16px; flex-wrap:wrap;">
          <select id="selectProceso" style="flex:1; min-width:200px; padding:10px 12px; border:1px solid #e2e8f0; border-radius:8px; font-size:14px;">
            <option value="">-- Seleccionar proceso --</option>
            {% for p in procesos %}
            <option value="{{ p.id }}" data-codigo="{{ p.codigo or '' }}" data-nombre="{{ p.nombre }}" data-ct="{{ p.centro_trabajo or '' }}" data-oper="{{ p.operacion or '' }}" data-te="{{ p.tiempo_estimado or '' }}">{{ p.centro_trabajo or 'C.T.?'}} - {{ p.operacion or p.nombre }}</option>
            {% endfor %}
          </select>
          <button type="button" id="btnAgregarProceso" class="btn" style="padding:10px 16px; border:none; background:#48bb78; color:#fff; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; transition:background 0.2s;">+ Agregar</button>
        </div>

        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#f7fafc;">
                <th style="text-align:left; padding:10px 8px; border-bottom:2px solid #e2e8f0; color:#4a5568; font-weight:600; white-space:nowrap;">#</th>
                <th style="text-align:left; padding:10px 8px; border-bottom:2px solid #e2e8f0; color:#4a5568; font-weight:600;">C.T. / Operaci√≥n</th>
                <th style="text-align:left; padding:10px 8px; border-bottom:2px solid #e2e8f0; color:#4a5568; font-weight:600; white-space:nowrap;">T/E</th>
                <th style="text-align:left; padding:10px 8px; border-bottom:2px solid #e2e8f0; color:#4a5568; font-weight:600; white-space:nowrap;">T/CT</th>
                <th style="text-align:left; padding:10px 8px; border-bottom:2px solid #e2e8f0; color:#4a5568; font-weight:600; white-space:nowrap;">T/CO</th>
                <th style="text-align:left; padding:10px 8px; border-bottom:2px solid #e2e8f0; color:#4a5568; font-weight:600; white-space:nowrap;">T/O</th>
                <th style="text-align:left; padding:10px 8px; border-bottom:2px solid #e2e8f0; color:#4a5568; font-weight:600; white-space:nowrap;">Total</th>
                <th style="text-align:left; padding:10px 8px; border-bottom:2px solid #e2e8f0; color:#4a5568; font-weight:600;">Notas</th>
                <th style="text-align:center; padding:10px 8px; border-bottom:2px solid #e2e8f0; color:#4a5568; font-weight:600;">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodySecuencia">
              {% for cp in clave_sel.procesos %}
              <tr style="border-bottom:1px solid #edf2f7;">
                <td style="padding:8px;">
                  <input type="number" name="orden[]" value="{{ cp.orden }}" style="width:50px; padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px;">
                </td>
                <td style="padding:8px;">
                  <input type="text" name="ct[]" value="{{ cp.centro_trabajo or cp.proceso.centro_trabajo or '' }}" placeholder="C.T." style="width:100%; max-width:120px; padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; margin-bottom:4px; font-size:13px;">
                  <input type="text" name="operacion[]" value="{{ cp.operacion or cp.proceso.operacion or '' }}" placeholder="Operaci√≥n" style="width:100%; padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px;">
                </td>
                <td style="padding:8px;"><input type="text" name="t_e[]" value="{{ cp.t_e or cp.proceso.tiempo_estimado or '' }}" placeholder="T/E" style="width:80px; padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px;" class="input-te"></td>
                <td style="padding:8px;"><input type="text" name="t_tct[]" value="{{ cp.t_tct or '' }}" placeholder="T/CT" style="width:80px; padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px;"></td>
                <td style="padding:8px;"><input type="text" name="t_tco[]" value="{{ cp.t_tco or '' }}" placeholder="T/CO" style="width:80px; padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px;"></td>
                <td style="padding:8px;"><input type="text" name="t_to[]" value="{{ cp.t_to or '' }}" placeholder="T/O" style="width:80px; padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px;"></td>
                <td style="padding:8px;"><input type="text" name="tiempo_est[]" value="{{ cp.tiempo_estimado or '' }}" placeholder="Total" style="width:80px; padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px;"></td>
                <td style="padding:8px;">
                  <input type="text" name="notas[]" value="{{ cp.notas or '' }}" placeholder="Notas" style="width:100%; padding:6px 8px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px;">
                </td>
                <td style="padding:8px; white-space:nowrap; text-align:center;">
                  <input type="hidden" name="proceso_id[]" value="{{ cp.proceso_id }}">
                  <button type="button" class="btnUp" title="Subir" style="padding:6px 10px; border:1px solid #e2e8f0; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">‚ñ≤</button>
                  <button type="button" class="btnDown" title="Bajar" style="padding:6px 10px; border:1px solid #e2e8f0; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">‚ñº</button>
                  <button type="button" class="btnRemove" title="Quitar" style="padding:6px 10px; border:1px solid #fc8181; background:#fff; color:#c53030; border-radius:4px; cursor:pointer; font-size:14px;">‚úñ</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div style="text-align:right; margin-top:16px;">
          <button type="submit" class="btn" style="padding:10px 16px; border:none; background:#3182ce; color:#fff; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; transition:background 0.2s;">üíæ Guardar secuencia</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>

  <style>
    /* Hover effects */
    .btn:hover { opacity: 0.9; }
    .clave-item:hover { background-color: #edf2f7; }
    .itemProc:hover { background-color: #f7fafc; }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .procesos-layout {
        grid-template-columns: 1fr !important;
      }
      .procesos-layout > div:first-child {
        order: 2;
      }
      .procesos-layout > div:last-child {
        order: 1;
      }
    }
    
    @media (max-width: 768px) {
      .admin-container {
        padding: 16px !important;
      }
      table {
        font-size: 12px !important;
      }
      input, select, textarea, button {
        font-size: 13px !important;
    }
  </style>

<script>
  // Filtro r√°pido en listas
  const buscarClave = document.getElementById('buscarClave');
  if (buscarClave) {
    buscarClave.addEventListener('input', () => {
      const term = buscarClave.value.toLowerCase();
      document.querySelectorAll('a[href*="clave_id="]').forEach(a => {
        a.style.display = a.textContent.toLowerCase().includes(term) ? '' : 'none';
      });
    });
  }
  const buscarProceso = document.getElementById('buscarProceso');
  if (buscarProceso) {
    buscarProceso.addEventListener('input', () => {
      const term = buscarProceso.value.toLowerCase();
      document.querySelectorAll('.itemProc').forEach(div => {
        div.style.display = div.textContent.toLowerCase().includes(term) ? 'flex' : 'none';
      });
    });
  }

  // Nueva clave: limpiar formulario central
  const btnNuevaClave = document.getElementById('btnNuevaClave');
  if (btnNuevaClave) {
    btnNuevaClave.addEventListener('click', () => {
      const url = new URL(window.location.href);
      url.searchParams.delete('clave_id');
      window.location.href = url.toString();
    });
  }

  // Secuencia: agregar desde select
  const btnAgregarProceso = document.getElementById('btnAgregarProceso');
  if (btnAgregarProceso) {
    btnAgregarProceso.addEventListener('click', () => {
      const sel = document.getElementById('selectProceso');
      const val = sel.value;
      if (!val) return;
      const codigo = sel.options[sel.selectedIndex].dataset.codigo;
      const nombre = sel.options[sel.selectedIndex].dataset.nombre;
      const defCt = sel.options[sel.selectedIndex].dataset.ct || '';
      const defOper = sel.options[sel.selectedIndex].dataset.oper || '';
      const defTe = sel.options[sel.selectedIndex].dataset.te || '';
      const tbody = document.getElementById('tbodySecuencia');
      const orden = tbody.querySelectorAll('tr').length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:6px;"><input type="number" name="orden[]" value="${orden}" style="width:64px; padding:6px; border:1px solid #ddd; border-radius:6px;"></td>
        <td style="padding:6px;">
          <div><input type=\"text\" name=\"ct[]\" value=\"${defCt}\" placeholder=\"C.T.\" style=\"width:140px; padding:6px; border:1px solid\n#ddd; border-radius:6px;\"></div>
          <div style=\"margin-top:6px;\"><input type=\"text\" name=\"operacion[]\" value=\"${defOper}\" placeholder=\"Operaci√≥n\" style=\"width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;\"></div>
        </td>
        <td style=\"padding:6px;\"><input type=\"text\" name=\"t_e[]\" value=\"${defTe}\" placeholder=\"T/E\" style=\"width:90px; padding:6px; border:1px solid #ddd; border-radius:6px;\"></td>
        <td style=\"padding:6px;\"><input type=\"text\" name=\"t_tct[]\" placeholder=\"T/CT\" style=\"width:90px; padding:6px; border:1px solid #ddd; border-radius:6px;\"></td>
        <td style=\"padding:6px;\"><input type=\"text\" name=\"t_tco[]\" placeholder=\"T/CO\" style=\"width:90px; padding:6px; border:1px solid #ddd; border-radius:6px;\"></td>
        <td style=\"padding:6px;\"><input type=\"text\" name=\"t_to[]\" placeholder=\"T/O\" style=\"width:90px; padding:6px; border:1px solid #ddd; border-radius:6px;\"></td>
        <td style=\"padding:6px;\"><input type=\"text\" name=\"tiempo_est[]\" placeholder=\"Total\" style=\"width:90px; padding:6px; border:1px solid #ddd; border-radius:6px;\"></td>
        <td style=\"padding:6px;\"><input type=\"text\" name=\"notas[]\" placeholder=\"Notas\" style=\"width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;\"></td>
        <td style=\"padding:6px; white-space:nowrap;\">
          <input type=\"hidden\" name=\"proceso_id[]\" value=\"${val}\">
          <button type=\"button\" class=\"btnUp\" title=\"Subir\" style=\"padding:6px 8px;\">‚ñ≤</button>
          <button type=\"button\" class=\"btnDown\" title=\"Bajar\" style=\"padding:6px 8px;\">‚ñº</button>
          <button type=\"button\" class=\"btnRemove\" title=\"Quitar\" style=\"padding:6px 8px; color:#b71c1c;\">‚úñ</button>
        </td>`;
      tbody.appendChild(tr);
      sel.value = '';
      bindRowButtons(tr);
      calcularTiempos();
    });
  }

  function bindRowButtons(scope) {
    // Si scope es una fila individual, procesar solo esa; si no, procesar todas
    const rows = scope instanceof HTMLTableRowElement ? [scope] : document.querySelectorAll('#tbodySecuencia tr');
    
    rows.forEach(row => {
      // Solo procesar filas que a√∫n no tengan listeners
      if (row._boundButtons) return;
      row._boundButtons = true;

      const btnR = row.querySelector('.btnRemove');
      const btnU = row.querySelector('.btnUp');
      const btnD = row.querySelector('.btnDown');

      if (btnR) {
        btnR.addEventListener('click', (e) => {
          e.preventDefault();
          row.remove();
          renumerarOrden();
        });
      }

      if (btnU) {
        btnU.addEventListener('click', (e) => {
          e.preventDefault();
          const prev = row.previousElementSibling;
          if (prev) row.parentNode.insertBefore(row, prev);
          renumerarOrden();
        });
      }

      if (btnD) {
        btnD.addEventListener('click', (e) => {
          e.preventDefault();
          const next = row.nextElementSibling;
          if (next) row.parentNode.insertBefore(next, row);
          renumerarOrden();
        });
      }
    });
  }
  function renumerarOrden() {
    document.querySelectorAll('#tbodySecuencia tr').forEach((row, idx) => {
      const input = row.querySelector('input[name="orden[]"]');
      if (input) input.value = idx + 1;
    });
    calcularTiempos();
  }
  bindRowButtons(document);

  // Rellenar formulario de proceso al hacer clic en Editar
  document.querySelectorAll('.btnEditProc').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const wrap = e.target.closest('.itemProc');
      if (!wrap) return;
      document.getElementById('proc_id').value = wrap.dataset.id;
      document.getElementById('proc_nombre').value = wrap.dataset.nombre;
      document.getElementById('proc_oper').value = wrap.dataset.oper || '';
      document.getElementById('proc_ct').value = wrap.dataset.ct || '';
      document.getElementById('proc_te').value = wrap.dataset.te || '';
      document.getElementById('proc_desc').value = wrap.dataset.desc || '';
      document.getElementById('proc_activo').checked = true;
      window.scrollTo({ top: document.getElementById('formProceso').offsetTop - 20, behavior: 'smooth' });
    });
  });
  document.getElementById('btnLimpiarProc')?.addEventListener('click', () => {
    document.getElementById('proc_id').value = '';
    document.getElementById('proc_nombre').value = '';
    document.getElementById('proc_oper').value = '';
    document.getElementById('proc_ct').value = '';
    document.getElementById('proc_te').value = '';
    document.getElementById('proc_desc').value = '';
    document.getElementById('proc_activo').checked = true;
  });

  // Utility functions for time parsing and formatting
  function parseTime(str) {
    // Convierte HH:MM:SS a segundos totales
    if (!str) return 0;
    const parts = String(str).split(':').map(p => parseInt(p.trim()) || 0);
    if (parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
    if (parts.length === 2) return parts[0]*60 + parts[1];
    return parts[0] || 0;
  }

  function formatTime(sec) {
    // Convierte segundos totales a HH:MM:SS
    sec = Math.round(sec || 0);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  // Auto-calculate T/CT and T/O based on T/E grouped by C.T.
  function calcularTiempos() {
    const rows = document.querySelectorAll('#tbodySecuencia tr');
    if (rows.length === 0) return;
    
    const ctGroups = {}; // { 'CNC': [row1, row2], 'TALADROS': [row3, row4, row5] }
    
    // Group rows by C.T.
    rows.forEach(row => {
      const ctInput = row.querySelector('input[name="ct[]"]');
      const ct = (ctInput?.value || '').trim().toUpperCase();
      if (ct) {
        if (!ctGroups[ct]) ctGroups[ct] = [];
        ctGroups[ct].push(row);
      }
    });

    let totalTCT = 0; // suma de todos los T/CT

    // For each C.T. group, sum T/E and put result in T/CT of last row
    Object.keys(ctGroups).forEach(ct => {
      const group = ctGroups[ct];
      let sumTE = 0;
      
      group.forEach((row, idx) => {
        const teInput = row.querySelector('input[name="t_e[]"]');
        const tctInput = row.querySelector('input[name="t_tct[]"]');
        const teValue = teInput?.value || '00:00:00';
        const te = parseTime(teValue);
        sumTE += te;
        
        // Clear T/CT for non-last rows
        if (idx < group.length - 1) {
          if (tctInput) tctInput.value = '';
        }
      });

      // Put sum in last row's T/CT
      const lastRow = group[group.length - 1];
      const lastTCT = lastRow.querySelector('input[name="t_tct[]"]');
      if (lastTCT) {
        lastTCT.value = formatTime(sumTE);
      }
      totalTCT += sumTE;
    });

    // Put total in T/O of last overall row
    const lastRow = rows[rows.length - 1];
    if (lastRow) {
      const toInput = lastRow.querySelector('input[name="t_to[]"]');
      if (toInput) toInput.value = formatTime(totalTCT);
      
      // Clear T/O for all other rows
      rows.forEach((row, idx) => {
        if (idx < rows.length - 1) {
          const toInput = row.querySelector('input[name="t_to[]"]');
          if (toInput) toInput.value = '';
        }
      });
    }
  }

  // Recalculate on T/E or CT change
  document.getElementById('tbodySecuencia')?.addEventListener('input', (e) => {
    if (e.target.matches('input[name="t_e[]"]') || e.target.matches('input[name="ct[]"]')) {
      calcularTiempos();
    }
  });

  // Initial calculation if rows exist
  if (document.querySelectorAll('#tbodySecuencia tr').length > 0) {
    calcularTiempos();
  }
</script>
