<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Hoja de Ruta</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .form-card { background:#fff; border:1px solid #e0e0e0; border-radius:10px; padding:18px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
        .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; }
        label { font-weight:600; font-size:13px; color:#333; }
        input, select, textarea { width:100%; padding:8px; border:1px solid #d4d4d4; border-radius:6px; font-size:14px; }
        textarea { resize: vertical; min-height: 80px; }
        .section-title { margin:18px 0 8px; font-weight:700; color:#0b74de; }
        .actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
        .btn { padding:10px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:700; }
        .btn-primary { background:#0b74de; color:#fff; }
        .btn-secondary { background:#eef2f5; color:#333; }
        .inline { display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
        .flag { display:flex; gap:8px; align-items:center; }
    </style>
</head>
<body>
    {% include '_sidebar.html' %}

    <div class="container">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <h2 style="margin:0;">Nueva Hoja de Ruta</h2>
            <div></div>
        </div>

        <div class="form-card">
            <form id="hojaForm">
                <div class="grid">
                    <div>
                        <label>Nombre de hoja</label>
                        <input name="nombre" required placeholder="Ej: Hoja ruta pieza X">
                    </div>
                    <div>
                        <label>Clave *</label>
                        <select name="clave_id" id="clave_id" required>
                            <option value="">Selecciona clave</option>
                        </select>
                    </div>
                    <div>
                        <label>Calidad (Supervisor)</label>
                        <select name="calidad" id="calidad">
                            <option value="">Selecciona supervisor</option>
                            <option>Evelyn</option>
                            <option>Moisés</option>
                        </select>
                    </div>
                    <div>
                        <label>Fecha de salida</label>
                        <input type="datetime-local" name="fecha_salida">
                    </div>
                    <div>
                        <label>Cantidad de piezas *</label>
                        <input type="number" name="cantidad_piezas" id="cantidad_piezas" min="1" step="1" required>
                    </div>
                    <div>
                        <label>Orden de trabajo</label>
                        <input name="orden_trabajo" placeholder="OT o NR">
                    </div>
                    <div>
                        <label>Almacén</label>
                        <select name="almacen">
                            <option value="">Selecciona almacén</option>
                            <option>AlmacenPT</option>
                            <option>AlmacenMP</option>
                            <option>Maquinaria</option>
                        </select>
                    </div>
                    <div>
                        <label>No de orden</label>
                        <input name="no_sin_orden" placeholder="OT o NR">
                    </div>
                    <div>
                        <label>Materia prima</label>
                        <select name="materia_prima" id="materia_prima">
                            <option value="">Cargar al tener datos</option>
                        </select>
                    </div>
                    <div>
                        <label>Total de tiempo (calculado)</label>
                        <input name="total_tiempo" id="total_tiempo" placeholder="00:00:00" readonly style="background:#f5f7fb;">
                    </div>
                    <div>
                        <label>Días a laborar (calculado)</label>
                        <input type="text" name="dias_a_laborar" id="dias_a_laborar" readonly style="background:#f5f7fb;">
                    </div>
                    <div>
                        <label>Fecha de término (calculada)</label>
                        <input type="datetime-local" name="fecha_termino" id="fecha_termino" readonly style="background:#f5f7fb;">
                    </div>
                </div>

                <div class="section-title">Datos opcionales</div>
                <div class="grid">
                    <div>
                        <label>Scrap (opcional)</label>
                        <input name="scrap" placeholder="Información de scrap">
                    </div>
                    <div>
                        <label>Retrabajo (opcional)</label>
                        <input name="retrabajo" placeholder="Información de retrabajo">
                    </div>
                    <div>
                        <label>Operador</label>
                        <input name="operador">
                    </div>
                    <div>
                        <label>Eficiencia (%)</label>
                        <input type="number" name="eficiencia" step="0.01" min="0" max="100" placeholder="0-100">
                    </div>
                </div>

                <div class="section-title">Descripción</div>
                <textarea name="descripcion" placeholder="Notas de la hoja"></textarea>

                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear hoja</button>
                </div>
            </form>
        </div>

        {% if hojas %}
        <div class="section-title">Hojas de ruta creadas recientemente</div>
        <div class="form-card" style="margin-top:10px;">
            <div class="inline" style="margin-bottom:10px;">
                <div>
                    <label>Filtrar por máquina</label>
                    <select id="filtroMaquina">
                        <option value="">Todas</option>
                        {% for m in maquinas %}
                        <option value="{{ m.nombre }}">{{ m.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f5f7fb;">
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #e0e0e0;">ID</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #e0e0e0;">Máquina</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #e0e0e0;">Nombre</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #e0e0e0;">Estado</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #e0e0e0;">Piezas</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #e0e0e0;">Creada</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #e0e0e0;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaHojas">
                        {% for h in hojas %}
                        <tr data-maq="{{ h.maquina }}" data-maquina_id="{{ h.maquina_id }}">
                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ h.id }}</td>
                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ h.maquina }}</td>
                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ h.nombre }}</td>
                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ h.estado }}</td>
                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ h.cantidad_piezas or '' }}</td>
                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ h.fecha_creacion[:16] if h.fecha_creacion }}</td>
                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;"><a href="/hoja/{{ h.id }}">Ver</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="form-card" style="margin-top:10px; color:#777;">Aún no hay hojas registradas.</div>
        {% endif %}
    </div>

    <script>
    let clavesData = []; // Almacenar claves con sus procesos y tiempo T/O
    
    // Cargar claves al inicio
    async function cargarClaves() {
        try {
            const res = await fetch('/api/claves_procesos');
            if (res.ok) {
                clavesData = await res.json();
                const select = document.getElementById('clave_id');
                select.innerHTML = '<option value="">Selecciona clave</option>';
                clavesData.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = `${c.clave} - ${c.nombre || 'Sin nombre'}`;
                    opt.dataset.tiempo_to = c.tiempo_to;
                    opt.dataset.clave = c.clave;
                    select.appendChild(opt);
                });
            }
        } catch (err) {
            console.error('Error cargando claves:', err);
        }
    }

    // Función para parsear tiempo HH:MM:SS a segundos
    function parseTime(str) {
        if (!str) return 0;
        const parts = String(str).split(':').map(p => parseInt(p.trim()) || 0);
        if (parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
        if (parts.length === 2) return parts[0]*60 + parts[1];
        return parts[0] || 0;
    }

    // Función para formatear segundos a HH:MM:SS
    function formatTime(sec) {
        sec = Math.round(sec || 0);
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    // Calcular tiempos cuando cambia clave o cantidad
    function calcularTiempos() {
        const claveId = document.getElementById('clave_id').value;
        const cantidadPiezas = parseInt(document.getElementById('cantidad_piezas').value) || 0;
        
        if (!claveId || cantidadPiezas <= 0) {
            document.getElementById('total_tiempo').value = '';
            document.getElementById('dias_a_laborar').value = '';
            document.getElementById('fecha_termino').value = '';
            return;
        }

        const select = document.getElementById('clave_id');
        const option = select.querySelector(`option[value="${claveId}"]`);
        const tiempoTO = option ? option.dataset.tiempo_to : '00:00:00';
        
        // Tiempo base por pieza (en segundos)
        const segundosPorPieza = parseTime(tiempoTO);
        
        // Total tiempo = T/O × piezas
        const totalSegundos = segundosPorPieza * cantidadPiezas;
        document.getElementById('total_tiempo').value = formatTime(totalSegundos);
        
        // Jornada: 6:30-12:00 (5.5h) + 12:30-16:00 (3.5h) = 9 horas por día
        // Corrección: 6:30-12:00 = 5.5h, 12:30-16:00 = 3.5h → total 9h
        // Pero mencionaste 7.5h, verifico: 6:30-12:00 = 5.5h, 12:30-4pm = 3.5h → 9h
        // Usaré 9 horas por día como en el horario dado
        const horasPorDia = 9;
        const segundosPorDia = horasPorDia * 3600;
        const diasALaborar = totalSegundos / segundosPorDia;
        document.getElementById('dias_a_laborar').value = diasALaborar.toFixed(2);
        
        // Fecha de término: hoy + días laborales
        const ahora = new Date();
        const diasCompletos = Math.ceil(diasALaborar);
        const fechaTermino = new Date(ahora);
        fechaTermino.setDate(fechaTermino.getDate() + diasCompletos);
        
        // Formato datetime-local: YYYY-MM-DDTHH:MM
        const year = fechaTermino.getFullYear();
        const month = String(fechaTermino.getMonth() + 1).padStart(2, '0');
        const day = String(fechaTermino.getDate()).padStart(2, '0');
        const hours = String(fechaTermino.getHours()).padStart(2, '0');
        const minutes = String(fechaTermino.getMinutes()).padStart(2, '0');
        document.getElementById('fecha_termino').value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Event listeners
    document.getElementById('clave_id').addEventListener('change', calcularTiempos);
    document.getElementById('cantidad_piezas').addEventListener('input', calcularTiempos);

    // Cargar claves al inicio
    cargarClaves();

    const form = document.getElementById('hojaForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = {};
        fd.forEach((v, k) => { payload[k] = v; });

        if (!payload.nombre || !payload.clave_id || !payload.cantidad_piezas) {
            alert('Nombre, clave y cantidad de piezas son obligatorios');
            return;
        }

        // Convertir clave_id a entero
        payload.clave_id = parseInt(payload.clave_id);
        payload.cantidad_piezas = parseInt(payload.cantidad_piezas);
        
        // Normalizar vacíos
        ['dias_a_laborar','eficiencia'].forEach(key => {
            if (payload[key] === '') payload[key] = null; else payload[key] = parseFloat(payload[key]);
        });
        if (payload.fecha_salida === '') payload.fecha_salida = null; 
        if (payload.fecha_termino === '') payload.fecha_termino = null;

        // Adapt datetime-local to ISO
        if (payload.fecha_salida) {
            payload.fecha_salida = payload.fecha_salida.replace('T', ' ');
        }
        if (payload.fecha_termino) {
            payload.fecha_termino = payload.fecha_termino.replace('T', ' ');
        }

        try {
            const res = await fetch('/api/hojas_ruta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok && (data.id || data.hoja || data.success)) {
                alert('Hoja creada correctamente');
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'No se pudo crear la hoja'));
            }
        } catch (err) {
            console.error(err);
            alert('Error al conectar');
        }
    });

    // Filtro por máquina
    const filtro = document.getElementById('filtroMaquina');
    const tbody = document.getElementById('tablaHojas');
    if (filtro && tbody) {
        filtro.addEventListener('change', () => {
            const term = filtro.value.trim();
            Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                const m = tr.getAttribute('data-maq') || '';
                tr.style.display = !term || m === term ? '' : 'none';
            });
        });
    }


    </script>
</body>
</html>
